#!/bin/bash

# Qdrant Vector Store - Start Script
# Can be run from anywhere

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
QDRANT_DIR="$(dirname "$SCRIPT_DIR")"  # qdrant_docker directory
VECTOR_STORE_DIR="$(dirname "$QDRANT_DIR")"  # vector_store directory

echo "ğŸš€ Starting Qdrant Vector Store..."

# Check if CL_SERVER_DIR is set
if [ -z "$CL_SERVER_DIR" ]; then
    echo "âŒ Error: CL_SERVER_DIR environment variable must be set"
    echo "   Example: export CL_SERVER_DIR=/path/to/data"
    exit 1
fi

# Check if CL_SERVER_DIR has write permission
if [ ! -w "$CL_SERVER_DIR" ]; then
    echo "âŒ Error: No write permission for CL_SERVER_DIR: $CL_SERVER_DIR"
    exit 1
fi

# Check if Docker is running
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Error: Docker is not running. Please start Docker first."
    exit 1
fi

# Create data directory if it doesn't exist
mkdir -p "$CL_SERVER_DIR/vector_store/qdrant"

# Start Qdrant container
echo "ğŸ“¦ Starting Qdrant container..."
cd "$QDRANT_DIR"
docker-compose up -d

# Wait for Qdrant to be healthy
echo "â³ Waiting for Qdrant to be ready..."
max_attempts=30
attempt=0

while [ $attempt -lt $max_attempts ]; do
    if curl -s http://localhost:6333/health > /dev/null 2>&1; then
        echo "âœ… Qdrant is ready!"
        echo ""
        echo "ğŸ“Š Qdrant Dashboard: http://localhost:6333/dashboard"
        echo "ğŸ”Œ REST API: http://localhost:6333"
        echo "ğŸ”Œ gRPC API: localhost:6334"
        echo ""
        echo "ğŸ’¾ Data stored in: $CL_SERVER_DIR/vector_store/qdrant"
        echo ""
        echo "To stop: $SCRIPT_DIR/vector_store_stop"
        echo "To view logs: cd $QDRANT_DIR && docker-compose logs -f qdrant"
        exit 0
    fi
    
    attempt=$((attempt + 1))
    sleep 2
done

echo "âŒ Qdrant failed to start within 60 seconds"
echo "Check logs with: cd $QDRANT_DIR && docker-compose logs qdrant"
exit 1

